(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[3],{1:function(e,t){},10:function(e,t){},2:function(e,t){},3:function(e,t){},4:function(e,t){},5:function(e,t){},"547a":function(e,t,s){"use strict";s.r(t);s("e6cf"),s("ddb0");var n=s("9523"),o=s.n(n);const a=s("1712").to,r=s("bc3a"),i=s("1232").default,l=s("4556"),c=s("e350").default;console.log(c);class u extends c{constructor(){var e;super(),e=this,o()(this,"settings",{}),o()(this,"setSettings",(e=>{for(let t in e){let s=e[t];this.settings[t]=s}})),o()(this,"setToken",(e=>{let t=e.token,s=e.refreshToken;window.localStorage.setItem("tbTokenGSAC",t),window.localStorage.setItem("tbRefreshTokenGSAC",s)})),o()(this,"logout",(()=>{window.localStorage.removeItem("tbTokenGSAC"),window.localStorage.removeItem("tbRefreshTokenGSAC"),this.jwt_token=null})),o()(this,"login",(async function(t){return new Promise((async function(s,n){let o=`${e.settings.TBURL}/auth/login`,[i,l]=await a(r.post(o,t));return i?n(i):s(l.data)}))})),o()(this,"getToken",(async function(t,s){return new Promise((async function(t,n){let o=`${e.settings.TBURL}/auth/token`,[i,l]=await a(r.post(o,{refreshToken:s},{headers:{"Content-Type":"application/json","X-Authorization":"Bearer "+s}}));return i?n(i):t(l.data)}))})),o()(this,"isLoggedIn",(async function(){return new Promise((async function(t,s){let n=localStorage.getItem("tbTokenGSAC");if(!n)return s("missing token");let o=i(n);console.log(o),e.userId=o.userId,e.jwt_token=n;let r=o.exp;if(!r)return s("missing token expiry");let l=localStorage.getItem("tbRefreshTokenGSAC");r=parseInt(r),(new Date).getTime();{let[t,o]=await a(e.getToken(n,l));if(t)return s("could not find token");e.setToken(o),n=o.token}return t(n)}))})),o()(this,"fetchRoles",(async function(){return new Promise((async function(t,s){let[n,o]=await a(e.sendSaveTeletry({type:"roles",action:"get"}));if(n)return s(n);t(o)}))})),o()(this,"fetchProjects",(async function(){return new Promise((async function(t,s){let[n,o]=await a(e.sendSaveTeletry({type:"projects",action:"get"}));if(n)return s(n);t(o)}))})),o()(this,"whoAmI",(async function(){return new Promise((async function(t,s){let[n,o]=await a(e.readUserData());if(console.log("WHOAMI"),n)return s(n);t(o)}))})),o()(this,"fetchUsers",(async function(){return new Promise((async function(t,s){let[n,o]=await a(e.whoAmI());if(n)return s(n);let i,l=o.authority;if("TENANT_ADMIN"===l){let t=`${e.settings.TBURL}/tenant/customers?customerTitle=GS Publications`;if([n,o]=await a(r.get(t,{headers:{"Content-Type":"application/json","X-Authorization":"Bearer "+e.jwt_token}})),n)return s(n);i=o.data.id.id}else console.log("i am a customer...."),console.log(o),i=o.customerId.id;if(console.log("CUSTOMER ID",i),[n,o]=await a(e.sendSaveTeletry({type:"users",action:"get",customerId:i})),n)return s(n.msg||n);t(o)}))})),o()(this,"createRole",(async function(t){return new Promise((async function(s,n){let[o,r]=await a(e.sendSaveTeletry({type:"roles",action:"create",role:t}));if(o)return n(o);s(r)}))})),o()(this,"createUser",(async function(t,s){let{user:n,firstName:o,lastName:r,password:i}=t;return console.log("PPPPPPPPPPPPPPPPPPPPp"),new Promise((async function(t,l){console.log("step1...");let[c,u]=await a(e.sendSaveTeletry({type:"users",action:"create",user:n,firstName:o,lastName:r,password:i},s));if(c)return console.log("REJECTED========"),console.log(c),l(c);if(s){if(console.log("NEVER WAITING"),[c,u]=await a(e.checkSuccessfulCreateUser(n,i)),c)return l(c);t(u)}else{console.log("result from creating user");let s=JSON.parse(JSON.stringify(u));if(console.log(u),0===Object.keys(u).length){if([c,u]=await a(e.login({username:n,password:i})),c)return l("Registration failed. Please try submitting the form again");t({})}else t(s)}}))})),o()(this,"checkSuccessfulCreateUser",(async function(t,s){return new Promise((async function(n,o){let r=(new Date).getTime();console.log("starting for sure...");const i=async function(){console.log("here.....");let c=l({length:20,type:"url-safe"});return e.once(c,i),new Promise((async function(l,u){let[m,d]=await a(e.login({username:t,password:s}));if(m){console.log(m.data);let s=(new Date).getTime(),n=s-r;n<=1e4?e.emit(c):(e.removeListener(c,i),o(`Error creating account. Probably ${t} already exists`),u("Timed out"))}if(void 0!==d)return console.log(d),e.removeListener(c,i),l(d.data),n(d.data);{let t=(new Date).getTime(),s=t-r;s<=1e4?e.emit(c):(e.removeListener(c,i),o("Error creating account. Probably ${user} already exists"),u("Timed out"))}}))};await a(i())}))})),o()(this,"deleteUser",(async function(t){return new Promise((async function(s,n){console.log("STARGINT TO DELETE");let[o,r]=await a(e.sendSaveTeletry({type:"users",action:"delete",user:t}));if(o)return console.log("REJECTED========"),console.log(o),n(o);let i=JSON.parse(JSON.stringify(r));console.log(r),s(i)}))})),o()(this,"getActivationLink",(async function(t,s){return new Promise((async function(n,o){let i=`${e.settings.TBURL}/user/${t}/activationLink`,[l,c]=await a(r.get(`${e.settings.JSONPROXY}?path=${i}`,{headers:{"Content-Type":"application/json","X-Authorization":"Bearer "+s}}));if(l)return o(l);n(c.data)}))})),o()(this,"createProject",(async function(t){return new Promise((async function(s,n){let[o,r]=await a(e.sendSaveTeletry({type:"projects",action:"create",project:t}));if(console.log("adhkjashdkhasdk"),o)return n(o);console.log("RETURNED..."),console.log(r),s(r)}))})),o()(this,"deleteRole",(async function(t){return new Promise((async function(s,n){let[o,r]=await a(e.sendSaveTeletry({type:"roles",action:"delete",role:t}));if(o)return n(o);s(r)}))})),o()(this,"deleteProject",(async function(t){return new Promise((async function(s,n){let[o,r]=await a(e.sendSaveTeletry({type:"projects",action:"delete",project:t}));if(o)return n(o);s(r)}))})),o()(this,"readUserData",(async function(){return new Promise((async function(t,s){let n=`${e.settings.TBURL}/auth/user`,[o,i]=await a(r.get(n,{headers:{"Content-Type":"application/json","X-Authorization":"Bearer "+e.jwt_token}}));return o?s(o):t(i.data)}))})),o()(this,"sendSaveTeletry",(async function(t,s=!1){return t.userId||(t.userId=e.userId),t.jwt_token||e.jwt_token&&(t.jwt_token=e.jwt_token),t.rqId||(t.rqId=l({length:20,type:"url-safe"})),console.log("step2"),console.log({data:t}),new Promise((async function(n,o){let i=e.settings.PUBLIC_DEVICE_ACCESS_TOKEN;console.log(e.settings);let c=e.settings.CORS_PROXY,u=`${e.settings.TBURL}/v1/${i}/telemetry`;console.log(t);let[m,d]=await a(r.post(`${c}/${u}`,t,{headers:{"Content-Type":"application/json"}}));if(console.log("ERRED......"),console.log(m),console.log(d),m)return o(m);if(s)return console.log("NO WAITING.."),n(!0);let p=t.rqId,g=(new Date).getTime();const f=async function(){return new Promise((async function(t,s){let[r,i]=await a(e.readUserData()),c=l({length:20,type:"url-safe"});if(e.once(c,f),r)console.log(r.status),console.log(r.response.data.status),console.log(r.data),console.log(r),e.removeListener(c,f),401===r.response.data.status?(console.log("---------160"),t({}),n({})):(console.log("---------1601"),s(r),o(r));else if(void 0===i.additionalInfo)o("Unknown error occured"),s("Unknown error occured");else{let a=i.additionalInfo.responses;if(a&&a[p]){console.log("---------167");let r=a[p];return console.log(r),r.msg.error?(e.removeListener(c,f),s(r.msg.error),o(r.msg.error)):(console.log("returned...."),console.log(r.msg),n(r.msg),t(!0),console.log("after resolve....."),e.removeListener(c,f),n(r.msg))}{let t=(new Date).getTime(),n=t-g;n<=12e4?(console.log(n,p),e.emit(c)):(e.removeListener(c,f),o("timed out"),s("timed out"))}}}))};await a(f())}))}))}}const m=new u;t["default"]=m},6:function(e,t){},7:function(e,t){},8:function(e,t){},"8b24":function(e,t,s){"use strict";s.r(t);var n=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("q-page",{staticClass:"flex flex-center bg-primary"},[s("q-card",{staticClass:"bg-secondary text-white my-card",attrs:{dark:"",bordered:""}},[s("q-card-section",{staticClass:"text-center"},[s("div",{staticClass:"text-h6"},[e._v("Gospel Sounders Publications")]),s("div",{staticClass:"text-subtitle2"},[e._v("User Management")])]),s("q-separator",{attrs:{dark:"",inset:""}}),s("q-card-section",[s("q-tabs",{staticClass:"bg-secondary text-white shadow-2",attrs:{"inline-label":""},model:{value:e.tab,callback:function(t){e.tab=t},expression:"tab"}},[s("q-tab",{attrs:{name:"login",icon:"login",label:"Log in"}}),s("q-tab",{attrs:{name:"register",icon:"create",label:"Register"}})],1),"login"===e.tab?s("loginForm"):e._e(),"register"===e.tab?s("registrationForm"):e._e()],1)],1)],1)},o=[],a=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",[s("q-toggle",{attrs:{color:"secondary"},on:{input:e.toggled},model:{value:e.localAccept,callback:function(t){e.localAccept=t},expression:"localAccept"}}),e._v("I\n  accept the\n  "),s("a",{staticClass:"text-underline text-italic",staticStyle:{"text-decoration":"underline",cursor:"pointer"},attrs:{clickable:""},on:{click:e.showTerms}},[e._v("terms and conditions")]),s("q-dialog",{attrs:{"transition-show":"rotate","transition-hide":"rotate"},model:{value:e.termsDialog,callback:function(t){e.termsDialog=t},expression:"termsDialog"}},[s("q-card",[s("q-card-section",{staticClass:"q-pt-none"},[""!==e.termsText?s("q-markdown",[e._v("\n          "+e._s(e.termsText)+"\n        ")]):e._e()],1),s("q-card-actions",{attrs:{align:"right"}},[s("q-btn",{directives:[{name:"close-popup",rawName:"v-close-popup"}],attrs:{flat:"",label:"Cancel",color:"primary"}}),s("q-btn",{directives:[{name:"close-popup",rawName:"v-close-popup"}],attrs:{flat:"",label:"Ok",color:"primary"}})],1)],1)],1)],1)},r=[],i=(s("e6cf"),s("ddb0"),s("cf57"));const l=s("bc3a"),c=s("1712").to;var u={name:"terms",props:{accept:Boolean,main:Function},created(){this.myParent=this.main(),this.localAccept=this.accept},data(){return{localAccept:!1,myParent:null,termsText:"",termsDialog:!1}},methods:{async showTerms(){this.termsDialog=!0,this.working=!0,this.showCustom();let[e,t]=await c(l.get("https://raw.githubusercontent.com/GospelSounders/usermanagement/master/terms.md"));this.working=!1,t&&(this.termsText=t.data)},toggled(e){this.$nextTick((function(){this.myParent.changeAccept(e)}))},showCustom(e=""){const t=this.$q.dialog({title:e,message:"",progress:{spinner:i["a"],color:"primary"},persistent:!0,ok:!1}),s=setInterval((()=>{!1===this.working&&(clearInterval(s),t.hide())}),500)}}},m=u,d=s("2877"),p=s("9564"),g=s("24e8"),f=s("f09f"),h=s("a370"),w=s("4b7e"),y=s("9c40"),b=s("7f67"),v=s("eebe"),k=s.n(v),T=Object(d["a"])(m,a,r,!1,null,null,null),P=T.exports;k()(T,"components",{QToggle:p["a"],QDialog:g["a"],QCard:f["a"],QCardSection:h["a"],QCardActions:w["a"],QBtn:y["a"]}),k()(T,"directives",{ClosePopup:b["a"]});var C=function(){var e=this,t=this,s=t.$createElement,n=t._self._c||s;return n("q-form",{staticClass:"q-gutter-md text-white",on:{submit:t.onSubmit,reset:t.onReset}},[n("q-input",{attrs:{filled:"",type:"email",label:"email",hint:"email","lazy-rules":"",rules:[function(e){return e&&e.length>0||"Please enter your email address"},function(t){return e.isValidEmail()||"Invalid email address"}]},model:{value:t.email,callback:function(e){t.email=e},expression:"email"}}),n("q-input",{attrs:{filled:"",type:"password",label:"Password","lazy-rules":"",rules:[function(e){return null!==e&&""!==e||"Please enter your password"}],"error-message":t.passwordErrorMessage},model:{value:t.password,callback:function(e){t.password=e},expression:"password"}}),n("div",[n("q-btn",{attrs:{label:"Submit",type:"submit",color:"primary"}}),n("q-btn",{staticClass:"q-ml-sm",attrs:{label:"Reset",type:"reset",color:"primary",flat:""}})],1)],1)},S=[];s("bc3a");const I=s("1712").to,q=s("ff00"),x=s("547a").default;console.log("+++++++++++++++++++++++++"),console.log(x);var E={name:"loginForm",props:{},async created(){x.setSettings({TBURL:q["TB_URL"]});let[e,t]=await I(x.isLoggedIn());t&&window.location.assign("#/home")},data(){return{loggedin:!1,working:!1,email:"",password:"",passwordErrorMessage:""}},methods:{isValidEmail(){const e=/^(?=[a-zA-Z0-9@._%+-]{6,254}$)[a-zA-Z0-9._%+-]{1,64}@(?:[a-zA-Z0-9-]{1,63}\.){1,8}[a-zA-Z]{2,63}$/;return e.test(this.email)||"Invalid email"},showCustom(e=""){const t=this.$q.dialog({title:e,message:"",progress:{spinner:i["a"],color:"primary"},persistent:!0,ok:!1}),s=setInterval((()=>{!1===this.working&&(clearInterval(s),t.hide())}),500)},async onSubmit(){x.setSettings({TBURL:q["TB_URL"]});q["TB_URL"];let e={username:this.email,password:this.password};this.working=!0,this.showCustom();let[t,s]=await I(x.login(e));if(this.working=!1,t)return this.loggedin=!1,this.$q.notify({type:"negative",message:"failed to log in"}),this.password="",void(this.passwordErrorMessage="wrong email/password");x.setToken(s),this.$q.notify({type:"positive",message:"log in successful"}),window.location.assign("#/home")},onReset(){this.email=null,this.password=null}}},R=E,_=s("0378"),A=s("27f9"),N=Object(d["a"])(R,C,S,!1,null,null,null),$=N.exports;k()(N,"components",{QForm:_["a"],QInput:A["a"],QBtn:y["a"]});var j=function(){var e=this,t=this,s=t.$createElement,n=t._self._c||s;return n("q-form",{ref:"userRegistrationForm",staticClass:"q-gutter-md text-white",on:{submit:t.createUser,reset:t.onReset}},[n("q-input",{attrs:{filled:"",type:"text",label:"first name",hint:"first name","lazy-rules":"",rules:[function(e){return e&&e.length>0||"Please enter your name"}]},on:{keyup:function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:t.submit(e)}},model:{value:t.firstName,callback:function(e){t.firstName=e},expression:"firstName"}}),n("q-input",{attrs:{filled:"",type:"text",label:"last name",hint:"last name","lazy-rules":"",rules:[function(e){return e&&e.length>0||"Please enter your name"}]},on:{keyup:function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:t.submit(e)}},model:{value:t.lastName,callback:function(e){t.lastName=e},expression:"lastName"}}),n("q-input",{attrs:{filled:"",type:"email",label:"email",hint:"email","lazy-rules":"",rules:[function(e){return e&&e.length>0||"Please enter your email address"},function(t){return e.isValidEmail()||"Invalid email address"}]},on:{keyup:function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:t.submit(e)}},model:{value:t.email,callback:function(e){t.email=e},expression:"email"}}),n("q-input",{attrs:{filled:"",type:"password",label:"Password","lazy-rules":"",rules:[function(e){return null!==e&&""!==e||"Please enter your password"}],"error-message":t.passwordErrorMessage},model:{value:t.password,callback:function(e){t.password=e},expression:"password"}}),n("q-input",{attrs:{filled:"",type:"password",label:"Password","lazy-rules":"",rules:[function(e){return null!==e&&""!==e||"Please enter your password"}],"error-message":t.passwordErrorMessage},model:{value:t.cpassword,callback:function(e){t.cpassword=e},expression:"cpassword"}}),n("terms",{attrs:{accept:t.accept,main:t.main}}),n("div",[n("q-btn",{attrs:{label:"Submit",type:"submit",color:"primary"}}),n("q-btn",{staticClass:"q-ml-sm",attrs:{label:"Reset",type:"reset",color:"primary",flat:""}})],1)],1)},L=[];s("bc3a");const U=s("1712").to,O=s("ff00"),B=s("547a").default;var D={name:"registrationForm",components:{terms:P},props:{},async created(){B.setSettings({TBURL:O["TB_URL"]}),B.setSettings(O);let[e,t]=await U(B.isLoggedIn());t&&window.location.assign("#/home")},data(){return{accept:!1,email:"",firstName:"",lastName:"",password:"",cpassword:"",passwordErrorMessage:"",users:[]}},methods:{changeAccept(e){this.accept=e},submit(){this.$refs.userRegistrationForm.submit()},main(){return this},isValidEmail(){const e=/^(?=[a-zA-Z0-9@._%+-]{6,254}$)[a-zA-Z0-9._%+-]{1,64}@(?:[a-zA-Z0-9-]{1,63}\.){1,8}[a-zA-Z]{2,63}$/;return e.test(this.email)||"Invalid email"},showCustom(e=""){const t=this.$q.dialog({title:e,message:"",progress:{spinner:i["a"],color:"primary"},persistent:!0,ok:!1}),s=setInterval((()=>{!1===this.working&&(clearInterval(s),t.hide())}),500)},async createUser(){return new Promise((async(e,t)=>{if(!0!==this.accept)return this.$q.notify({color:"red-5",textColor:"white",icon:"warning",message:"You need to accept the license and terms first"}),e(!1);if(this.password!==this.cpassword)return this.cpassword="",this.passwordErrorMessage="Passwords don't match",this.$q.notify({type:"negative",message:"Passwords don't match"}),e(!1);this.working=!0,this.showCustom();let[s,n]=await U(B.createUser({user:this.email,firstName:this.firstName,lastName:this.lastName,password:this.password},!0));this.working=!1,s?(this.$q.notify({type:"negative",message:s.msg||s}),e(!1)):(this.users.push(n),this.$q.notify({type:"positive",message:"Registration successful"}))}))},onReset(){this.email=null,this.password=null}}},z=D,Q=Object(d["a"])(z,j,L,!1,null,null,null),G=Q.exports;k()(Q,"components",{QForm:_["a"],QInput:A["a"],QToggle:p["a"],QBtn:y["a"]});var J={name:"PageIndex",components:{terms:P,loginForm:$,registrationForm:G},data(){return{tab:"login",name:null,age:null,accept:!1}},methods:{main(){return this},changeAccept(e){this.accept=e},onSubmit(){console.log(this.accept),!0!==this.accept?this.$q.notify({color:"red-5",textColor:"white",icon:"warning",message:"You need to accept the license and terms first"}):this.$q.notify({color:"green-4",textColor:"white",icon:"cloud_done",message:"Submitted"})},onReset(){this.name=null,this.age=null,this.accept=!1}}},F=J,M=s("9989"),Z=s("eb85"),X=s("429b"),V=s("7460"),Y=Object(d["a"])(F,n,o,!1,null,null,null);t["default"]=Y.exports;k()(Y,"components",{QPage:M["a"],QCard:f["a"],QCardSection:h["a"],QSeparator:Z["a"],QTabs:X["a"],QTab:V["a"]})},9:function(e,t){},e350:function(e,t,s){"use strict";s.r(t);s("c975"),s("a434");class n{constructor(){this.events={}}on(e,t){return"object"!==typeof this.events[e]&&(this.events[e]=[]),this.events[e].push(t),()=>this.removeListener(e,t)}removeListener(e,t){if("object"===typeof this.events[e]){const s=this.events[e].indexOf(t);s>-1&&this.events[e].splice(s,1)}}emit(e,...t){"object"===typeof this.events[e]&&this.events[e].forEach((e=>e.apply(this,t)))}once(e,t){const s=this.on(e,((...e)=>{s(),t.apply(this,e)}))}}t["default"]=n},ff00:function(e){e.exports=JSON.parse('{"TB_URL":"https://demo.thingsboard.io/api","PUBLIC_DEVICE_ACCESS_TOKEN":"9sE9Z86OdYsynyCJKjnq","CORS_PROXY":"https://cors.cseco.co.ke","JSONPROXY":"https://jsonproxy.cseco.co.ke"}')}}]);